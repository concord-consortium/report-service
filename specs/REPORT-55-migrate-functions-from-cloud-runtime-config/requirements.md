# Migrate Firebase Functions from Cloud Runtime Config to Parameterized Configuration

**Jira**: https://concord-consortium.atlassian.net/browse/REPORT-55
**Repo**: https://github.com/concord-consortium/report-service
**Implementation Spec**: [implementation.md](implementation.md)
**Status**: **Implemented — Pending Deploy**

## Overview

Migrate all `functions.config()` usage in the report-service Firebase Functions to the `firebase-functions/params` API (`defineString`/`defineSecret`) before the Cloud Runtime Config service shuts down in March 2026, which will break deploys.

## Project Owner Overview

Google is deprecating the Cloud Runtime Config service that backs `functions.config()` in Firebase Functions. After March 2026, any deploy that references `functions.config()` will fail, blocking all function updates for the report service.

The report service uses `functions.config()` to store four configuration values: AWS credentials for S3 syncing (access key, secret key, bucket name) and a bearer token for API authentication. This migration replaces those calls with the newer `firebase-functions/params` API, which uses environment variables and Secret Manager instead of the deprecated Runtime Config backend. This is a maintenance chore with no user-facing changes.

## Background

The report-service `functions/` directory contains Firebase Cloud Functions (Node.js 22, firebase-functions v4) that:
- Auto-import learner answers from Firestore to S3 as Parquet files
- Provide an Express-based API for importing runs/structures and querying resources

The codebase was recently upgraded from firebase-functions v3 to v4 (documented in `functions/firebase-functions-v3-to-v4-upgrade.md`). That upgrade noted `functions.config()` as deprecated-but-functional and deferred migration. The March 2026 deadline now makes migration urgent.

**Current `functions.config()` usage** (5 call sites across 2 files):

| Config Path | File | Lines | Purpose |
|---|---|---|---|
| `functions.config().aws.key` | `functions/src/auto-importer.ts` | 167 | AWS access key for S3 client |
| `functions.config().aws.secret_key` | `functions/src/auto-importer.ts` | 168 | AWS secret key for S3 client |
| `functions.config().aws.s3_bucket` | `functions/src/auto-importer.ts` | 205, 234 | S3 bucket name for uploads/deletes |
| `functions.config().auth.bearer_token` | `functions/src/middleware/bearer-token-auth.ts` | 15 | Bearer token for API auth |

**Current configuration workflow**:
- Values are set via `firebase functions:config:set` CLI commands (deprecated)
- Local development uses `.runtimeconfig.json` generated by `firebase functions:config:get`
- Two Firebase projects: `report-service-dev` (staging) and `report-service-pro` (production)

**Migration target**: The `firebase-functions/params` package provides `defineString()` for plain config and `defineSecret()` for sensitive values. Secrets are stored in Google Cloud Secret Manager. Non-secret params use `.env` files or environment variables.

## Requirements

- Replace all 5 `functions.config()` call sites with the `firebase-functions/params` API
- Use `defineSecret()` for sensitive credentials: `AWS_KEY`, `AWS_SECRET_KEY`, `AUTH_BEARER_TOKEN`
- Use `defineString()` for non-secret configuration: `AWS_S3_BUCKET`
- Bind secrets to each function that uses them via `.runWith({ secrets: [...] })`:
  - `syncToS3AfterSyncDocWritten`: bind `AWS_KEY` and `AWS_SECRET_KEY` (only auto-importer function that accesses S3)
  - API function (`wrappedApi` in `index.ts`): bind `AUTH_BEARER_TOKEN`
  - `createSyncDocAfterAnswerWritten` and `monitorSyncDocCount`: no secrets needed (Firestore-only)
- Provide a migration script that converts an existing `.runtimeconfig.json` to `.env` + `.secret.local` files
- Ensure the Firebase emulator continues to work for local development using `.env` and `.secret.local` files — specifically, `firebase emulators:start --only functions` must work with no `.runtimeconfig.json` present
- Update `functions/README.md` to document the new configuration approach, including: setting env vars, managing secrets via Secret Manager, running the migration script, a step-by-step migration runbook for each Firebase project (export old values, set secrets, verify, deploy), and deployment order (secrets must be set before first deploy)
- Update or remove the deprecation notes in `functions/firebase-functions-v3-to-v4-upgrade.md`
- Maintain the existing configuration values in both Firebase projects (`report-service-dev` and `report-service-pro`) — no data loss during migration
- No changes to function behavior — all functions must continue to work identically after migration
- Deploy successfully to both staging and production without `functions.config()` deprecation warnings
- Verification checklist:
  - Run `npm run build` in `functions/` first (so `lib/` reflects current source), then `grep -r --include="*.ts" --include="*.js" "functions\.config" functions/src/ functions/lib/` returns zero matches in code files (excludes comments in `.md` files)
  - No exported function other than `syncToS3AfterSyncDocWritten` calls any code path that reads `awsKey.value()` / `awsSecretKey.value()` or invokes `s3Client()`
  - `firebase deploy --only functions --project report-service-dev` picks up `.env.report-service-dev` correctly
  - Deploy to staging succeeds; hit an API route requiring bearer auth to confirm `AUTH_BEARER_TOKEN` works
  - Emulator starts and runs with `.env`/`.secret.local` files, no `.runtimeconfig.json`
  - After staging deploy, confirm functions can read secrets at runtime (no `PERMISSION_DENIED` or secret access errors in logs)

## Technical Notes

**Files to modify**:
- `functions/src/auto-importer.ts` — Replace `functions.config().aws.*` with params, add `runWith({ secrets: [awsKey, awsSecretKey] })` to `syncToS3AfterSyncDocWritten` only
- `functions/src/middleware/bearer-token-auth.ts` — Replace `functions.config().auth.*` with params; move secret access from module scope into the request handler function (required by `defineSecret` runtime constraint); define and export `bearerToken` param so `index.ts` can import it for `runWith`
- `functions/src/index.ts` — Add `runWith({ secrets: [bearerToken] })` to the API function
- `functions/README.md` — Update configuration documentation
- `functions/firebase-functions-v3-to-v4-upgrade.md` — Update deprecation status
- `functions/.gitignore` — Add `.secret.local` and `.env` (local emulator files containing secrets must not be committed)
- `functions/.env.report-service-dev` (new, committed) — Non-secret env vars for staging (`AWS_S3_BUCKET=concord-staging-report-data`)
- `functions/.env.report-service-pro` (new, committed) — Non-secret env vars for production (`AWS_S3_BUCKET=concord-report-data`)
- `functions/.secret.local` (new, gitignored) — Local development secrets for emulator
- `functions/scripts/migrate-config.sh` (new) — Converts `.runtimeconfig.json` to `.env` + `.secret.local` for local development:
  - Input: `functions/.runtimeconfig.json` (keys: `aws.key`, `aws.secret_key`, `aws.s3_bucket`, `auth.bearer_token`)
  - Writes `AWS_S3_BUCKET=<value>` to `.env` (non-secret, for emulator/local use only; deploy uses committed `.env.<alias>` files)
  - Writes `AWS_KEY=<value>`, `AWS_SECRET_KEY=<value>`, `AUTH_BEARER_TOKEN=<value>` to `.secret.local` (secrets)
  - Does not echo secret values to stdout
  - Reports missing keys with a warning rather than failing silently
  - Refuses to overwrite if `.env` or `.secret.local` already exist (exits non-zero; user must delete manually to re-run)
  - Exits non-zero if input `.runtimeconfig.json` is missing; warnings only for missing keys within the file
  - Does not set Secret Manager secrets (those must be set manually per project via `firebase functions:secrets:set`)

**Parameter names** (flat uppercase, Firebase convention):

| Parameter | API | Env Var Name |
|---|---|---|
| S3 bucket | `defineString("AWS_S3_BUCKET")` | `AWS_S3_BUCKET` |
| AWS access key | `defineSecret("AWS_KEY")` | `AWS_KEY` |
| AWS secret key | `defineSecret("AWS_SECRET_KEY")` | `AWS_SECRET_KEY` |
| Bearer token | `defineSecret("AUTH_BEARER_TOKEN")` | `AUTH_BEARER_TOKEN` |

**Secret binding** (1st gen `runWith`):
Each function that accesses a secret must declare it individually:
```typescript
export const syncToS3AfterSyncDocWritten = functions
  .runWith({ secrets: [awsKey, awsSecretKey] })
  .firestore.document(...)
  .onWrite(...)
```

**Firebase params API pattern**:
```typescript
import { defineString, defineSecret } from "firebase-functions/params";

const s3Bucket = defineString("AWS_S3_BUCKET");
const awsKey = defineSecret("AWS_KEY");
const awsSecretKey = defineSecret("AWS_SECRET_KEY");
const bearerToken = defineSecret("AUTH_BEARER_TOKEN");

// Access at runtime:
s3Bucket.value()        // for defineString
awsKey.value()          // for defineSecret (only inside function handler)
```

**Secret access constraint**: `defineSecret()` values can only be accessed inside a function handler that declares the secret in its `runWith` options (1st gen) or `secrets` option (2nd gen). Since these functions use the 1st gen API, secrets must be bound via `runWith({ secrets: [...] })`. This has two implications:
- `bearer-token-auth.ts` currently reads the auth config at module scope — that access must move inside the per-request handler function.
- Helpers like `s3Client()` that call `.value()` on secrets must only be invoked from within a function handler that has those secrets bound via `runWith`. Currently `s3Client()` is only called from `syncToS3()` and `deleteFromS3()`, which are only called from `syncToS3AfterSyncDocWritten` — this is correct, but the constraint should be understood by future maintainers.

**Migration of existing config values** (order matters — secrets must be set before deploying):
1. Non-secrets: Create per-project `.env.<alias>` files with `AWS_S3_BUCKET=<value>` (retrieve production bucket name from existing Runtime Config, e.g. `firebase use report-service-pro && firebase functions:config:get` and extract `aws.s3_bucket` from the JSON output)
2. Secrets: Set in Google Cloud Secret Manager via `firebase functions:secrets:set SECRET_NAME` for each project
3. Deploy: `firebase deploy --only functions` (deploy will fail with clear instructions if secrets are missing)

**Emulator support**: The Firebase emulator reads `.env` and `.secret.local` files for local development, replacing the role of `.runtimeconfig.json`.

**Rollback**: If the deploy fails or functions misbehave, revert the commit and re-deploy. The old Runtime Config values remain intact until the service shuts down in March 2026, so reverting restores full functionality.

**Runtime permissions**: Firebase is expected to automatically grant the Cloud Functions service account access to read secrets bound via `runWith`. No manual IAM configuration is typically needed, but this can fail if the service account is non-standard or org policy restricts secret access. Verify via the post-deploy log check in the verification checklist.

## Out of Scope

- Upgrading from 1st gen to 2nd gen Cloud Functions (separate effort)
- Migrating other non-Firebase configuration (e.g., query-creator Lambda environment variables)
- Changes to the Firestore security rules or indexes
- Changes to the CI/CD workflows (they don't reference `functions.config`)

## Open Questions

### RESOLVED: Secret binding strategy for 1st gen functions with `runWith`

**Context**: In 1st gen Firebase Functions, secrets declared with `defineSecret()` must be listed in `runWith({ secrets: [...] })` on each function that uses them. The auto-importer exports three functions (`createSyncDocAfterAnswerWritten`, `monitorSyncDocCount`, `syncToS3AfterSyncDocWritten`), and the API is wrapped via `functions.https.onRequest()`. Each function that accesses a secret must declare it.

**Decision**: Add `.runWith({ secrets: [awsKey, awsSecretKey] })` to `syncToS3AfterSyncDocWritten` (the only auto-importer function that accesses S3) and `.runWith({ secrets: [bearerToken] })` to the API function. The other two auto-importer functions (`createSyncDocAfterAnswerWritten`, `monitorSyncDocCount`) don't access secrets and need no binding.

### RESOLVED: Naming convention for parameter/secret names

**Context**: The `defineString`/`defineSecret` names become environment variable names. The current Runtime Config uses a nested format (`aws.key`, `aws.s3_bucket`, `auth.bearer_token`). The params API uses flat environment variable names.

**Decision**: Use flat uppercase names matching the Firebase convention: `AWS_KEY`, `AWS_SECRET_KEY`, `AWS_S3_BUCKET`, `AUTH_BEARER_TOKEN`.

### RESOLVED: Should the existing `.runtimeconfig.json` workflow be preserved as a fallback during transition?

**Context**: Developers may have existing `.runtimeconfig.json` files. The new approach uses `.env` / `.secret.local` files instead.

**Decision**: Provide a migration script that converts `.runtimeconfig.json` to `.env` + `.secret.local`. After migration, `.runtimeconfig.json` references will be removed from documentation in favor of the new approach.

## Self-Review

### Senior Engineer

#### RESOLVED: bearer-token-auth.ts accesses config at module level — incompatible with `defineSecret`

Updated Technical Notes to document the restructuring need: secret access must move from module scope into the per-request handler function in `bearer-token-auth.ts`.

---

#### RESOLVED: Files-to-modify entry for auto-importer.ts is inconsistent with decisions

Fixed Technical Notes to specify `runWith` only on `syncToS3AfterSyncDocWritten`.

---

### Security Engineer

#### RESOLVED: Should `functions/.env` (containing `AWS_S3_BUCKET`) be committed to the repo?

Use per-project `.env.<project-alias>` files (`.env.report-service-dev`, `.env.report-service-pro`) committed to the repo. These contain only the non-secret `AWS_S3_BUCKET` value. Firebase automatically loads the correct file based on the active project alias.

---

### DevOps Engineer

#### RESOLVED: No deployment ordering or pre-deploy verification for secrets

Added deployment ordering to Technical Notes (set secrets before deploying) and updated README requirement to include deployment order documentation. Deploy will fail with clear instructions if secrets are missing.

---

### Self-Review Round 2

### Senior Engineer

#### RESOLVED: `bearerToken` secret has a cross-file dependency not called out in files-to-modify

Updated files-to-modify: `bearerToken` is defined and exported from `bearer-token-auth.ts`, imported by `index.ts` for `runWith`.

---

### Security Engineer

#### RESOLVED: `.gitignore` needs updating for new secret files

Added `functions/.gitignore` to files-to-modify list: must add `.secret.local` and `.env` entries.

---

### DevOps Engineer

#### RESOLVED: Production bucket name is a placeholder

Added retrieval command to migration steps: `firebase use report-service-pro && firebase functions:config:get aws.s3_bucket`.
