defmodule ReportServer.PostProcessing.JobTest do
  use ExUnit.Case, async: true

  import ReportServer.JobFixtures

  alias ReportServer.PostProcessing.Job
  alias ReportServer.PostProcessing.Steps.{ClueLinkToWork, MergeToPrimaryUser}

  describe "run/4" do
    test "runs a job with empty input and no steps successfully" do
      {job, query_result, overrides, get_output} = job_fixture()

      assert {:ok, s3_url} = Job.run(job, query_result, nil, overrides)
      assert s3_url == "s3://streamed_output/jobs/test_result_job_1.csv"
      assert get_output.() == ""
    end

    test "runs a job with input and no steps successfully" do
      input = "header1,header2\r\nvalue1,value2\r\nvalue3,value4\r\n"
      {job, query_result, overrides, get_output} = job_fixture(input)

      Job.run(job, query_result, nil, overrides)
      assert get_output.() == input
    end

    test "runs the CLUE link to work step successfully" do
      parameters = %{"documentUid" => "77701","documentKey" => "-OHEW9eC90nMQtAZHZhU","documentHistoryId" => "pQ99dWPLmCIvqTUWDr5NH"}
      |> Jason.encode!()
      |> String.replace("\"", "\"\"")
      link_to_work = "https://collaborative-learning.concord.org/?class=https%3A%2F%2Fportal.example.com%2Fapi%2Fv1%2Fclasses%2F1&offering=https%3A%2F%2Fportal.example.com%2Fapi%2Fv1%2Fofferings%2F1&researcher=true&reportType=offering&authDomain=https%3A%2F%2Fportal.example.com%2F&resourceLinkId=1&targetUserId=77701&studentDocument=-OHEW9eC90nMQtAZHZhU&studentDocumentHistoryId=pQ99dWPLmCIvqTUWDr5NH"

      input = """
      "id","session","username","application","activity","event","event_value","time","parameters","extras","run_remote_endpoint","timestamp"
      "NecBSeH5aIvdb2hjFZ32M","ace3d0ef-52ee-4997-a8c5-59cb8591dca1","77701@learn.concord.org","CLUE",,"TEXT_TOOL_CHANGE",,"1737574924","#{parameters}","{}","https://learn.concord.org/dataservice/external_activity_data/1cf47468-e793-4a54-b457-e4718a2a5dc0","1737574924741"
      """

      output = """
      id,session,username,application,activity,event,event_value,time,link_to_work,parameters,extras,run_remote_endpoint,timestamp\r
      NecBSeH5aIvdb2hjFZ32M,ace3d0ef-52ee-4997-a8c5-59cb8591dca1,77701@learn.concord.org,CLUE,,TEXT_TOOL_CHANGE,,1737574924,#{link_to_work},"#{parameters}",{},https://learn.concord.org/dataservice/external_activity_data/1cf47468-e793-4a54-b457-e4718a2a5dc0,1737574924741\r
      """
      learners = %{
        "https://learn.concord.org/dataservice/external_activity_data/1cf47468-e793-4a54-b457-e4718a2a5dc0" => %{offering_id: 1, class_id: 1}
      }
      {job, query_result, overrides, get_output} = job_fixture(input, [ClueLinkToWork.step()], learners)

      Job.run(job, query_result, nil, overrides)
      assert get_output.() == output
    end

    test "runs the merge to primary user step successfully" do
      # note: this tests both the merging of Alias Neill and Fred Flintstone to Boris Neill based on the same primary_user_id and class_id
      # and the LACK of merging of Wilma Flintstone that has the same user_id but are in different classes
      # this also tests the case (Barney/Betty Rubble) where the primary_user_id is set for a user but it does not exist as a user in the class
      input = """
      "student_id","user_id","primary_user_id","student_name","username","school","class","class_id","permission_forms","teacher_user_ids","teacher_names","teacher_districts","teacher_states","teacher_emails","res_1_name","res_1_offering_id","res_1_learner_id","res_1_remote_endpoint","res_1_resource_url","res_1_last_run","res_1_total_num_questions","res_1_total_num_answers","res_1_total_percent_complete","res_1_num_required_questions","res_1_num_required_answers","res_1_q4_5_question1_text","res_1_q4_5_question1_url"
      "Correct answer",,,,,,,,,,,,,,,,,,,,,,,,,,
      "Prompt",,,,,,,,,,,,,,,,,,,,,,,,,"4_5_Question1","4_5_Question1"
      "136","279","266","Alias Neill","aneill","Concord Consortium","Aug2024","254","[]","88","Boris Goldowsky","","","bgoldowsky@concord.org","Test Clue","588","555","https://learn.portal.staging.concord.org/dataservice/external_activity_data/42519f74-e40a-43a6-a0cd-2d27e8c4132b","https://collaborative-learning.concord.org/?unit=m2s&problem=4.5","2025-03-10T21:03:59","1","1","100.0","0","0","Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  YAY!!! {Write your answer here}","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=279&studentDocument=-OL0rmfqiDsPlriZks-X&studentDocumentHistoryId=_n0gST0XUN0xt8JKoSUPZ"
      "123","266","266","Boris Neill","bneill","Concord Consortium","Aug2024","254","[]","88","Boris Goldowsky","","","bgoldowsky@concord.org","Test Clue","588","540","https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d0","https://collaborative-learning.concord.org/?unit=m2s&problem=4.5","2025-03-10T15:43:18","1","1","100.0","0","0","Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I've pulled in question 1 and am answering it.","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F84zu&studentDocumentHistoryId=anntEAki_54lesjhGRaFO"
      "124","267","266","Fred Flintstone","fflintstone","Concord Consortium","Aug2024","254","[]","88","Boris Goldowsky","","","bgoldowsky@concord.org","Test Clue","588","541","https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d1","https://collaborative-learning.concord.org/?unit=m2s&problem=4.5","2025-03-10T15:43:19","1","1","100.0","0","0","Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I don't know.","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F85zu&studentDocumentHistoryId=anntEAki_54lesjhGRaF1"
      "125","268","268","Wilma Flintstone","wflintstone","Concord Consortium","Aug2024","254","[]","88","Boris Goldowsky","","","bgoldowsky@concord.org","Test Clue","588","542","https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d2","https://collaborative-learning.concord.org/?unit=m2s&problem=4.5","2025-03-10T15:43:20","1","1","100.0","0","0","Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I like eggs.","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F86zu&studentDocumentHistoryId=anntEAki_54lesjhGRaF2"
      "126","268","268","Wilma Flintstone","wflintstone","Concord Consortium","Sep2024","255","[]","88","Boris Goldowsky","","","bgoldowsky@concord.org","Test Clue","588","542","https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d3","https://collaborative-learning.concord.org/?unit=m2s&problem=4.5","2025-03-10T15:44:20","1","1","100.0","0","0","Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I like eggs.","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F589&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=589&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F87zu&studentDocumentHistoryId=anntEAki_54lesjhGRaF3"
      "127","269","280","Barney Rubble","brubble","Concord Consortium","Aug2024","254","[]","88","Boris Goldowsky","","","bgoldowsky@concord.org","Test Clue","588","541","https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d4","https://collaborative-learning.concord.org/?unit=m2s&problem=4.5","2025-03-10T15:43:21","1","1","100.0","0","0","Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I like cheese.","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F85zp&studentDocumentHistoryId=anntEAki_54lesjhGRaF4"
      "128","270","280","Betty Rubble","mrsrubble","Concord Consortium","Aug2024","254","[]","88","Boris Goldowsky","","","bgoldowsky@concord.org","Test Clue","588","541","https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d5","https://collaborative-learning.concord.org/?unit=m2s&problem=4.5","2025-03-10T15:43:21","1","1","100.0","0","0","Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I like pizza.","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F85zq&studentDocumentHistoryId=anntEAki_54lesjhGRaF5"
      """

      output = """
      student_id,user_id,primary_user_id,merged_user_ids,student_name,username,school,class,class_id,permission_forms,teacher_user_ids,teacher_names,teacher_districts,teacher_states,teacher_emails,res_1_name,res_1_offering_id,res_1_learner_id,res_1_remote_endpoint,res_1_resource_url,res_1_last_run,res_1_total_num_questions,res_1_total_num_answers,res_1_total_percent_complete,res_1_num_required_questions,res_1_num_required_answers,res_1_q4_5_question1_text,res_1_q4_5_question1_url\r
      Correct answer,,,,,,,,,,,,,,,,,,,,,,,,,,,\r
      Prompt,,,,,,,,,,,,,,,,,,,,,,,,,,4_5_Question1,4_5_Question1\r
      123,266,266,\"279,267\",Boris Neill,bneill,Concord Consortium,Aug2024,254,[],88,Boris Goldowsky,,,bgoldowsky@concord.org,Test Clue,588,\"266: 540\n267: 541\n279: 555\",\"266: https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d0\n267: https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d1\n279: https://learn.portal.staging.concord.org/dataservice/external_activity_data/42519f74-e40a-43a6-a0cd-2d27e8c4132b\",https://collaborative-learning.concord.org/?unit=m2s&problem=4.5,\"266: 2025-03-10T15:43:18\n267: 2025-03-10T15:43:19\n279: 2025-03-10T21:03:59\",1,1,100.0,0,0,\"266: Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I've pulled in question 1 and am answering it.\n267: Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I don't know.\n279: Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  YAY!!! {Write your answer here}\",\"266: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F84zu&studentDocumentHistoryId=anntEAki_54lesjhGRaFO\n267: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F85zu&studentDocumentHistoryId=anntEAki_54lesjhGRaF1\n279: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=279&studentDocument=-OL0rmfqiDsPlriZks-X&studentDocumentHistoryId=_n0gST0XUN0xt8JKoSUPZ\"\r
      125,268,268,,Wilma Flintstone,wflintstone,Concord Consortium,Aug2024,254,[],88,Boris Goldowsky,,,bgoldowsky@concord.org,Test Clue,588,542,https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d2,https://collaborative-learning.concord.org/?unit=m2s&problem=4.5,2025-03-10T15:43:20,1,1,100.0,0,0,Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I like eggs.,https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F86zu&studentDocumentHistoryId=anntEAki_54lesjhGRaF2\r
      126,268,268,,Wilma Flintstone,wflintstone,Concord Consortium,Sep2024,255,[],88,Boris Goldowsky,,,bgoldowsky@concord.org,Test Clue,588,542,https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d3,https://collaborative-learning.concord.org/?unit=m2s&problem=4.5,2025-03-10T15:44:20,1,1,100.0,0,0,Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I like eggs.,https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F589&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=589&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F87zu&studentDocumentHistoryId=anntEAki_54lesjhGRaF3\r
      127,269,280,\"269,270\",Barney Rubble,brubble,Concord Consortium,Aug2024,254,[],88,Boris Goldowsky,,,bgoldowsky@concord.org,Test Clue,588,541,\"269: https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d4\n270: https://learn.portal.staging.concord.org/dataservice/external_activity_data/e59ef6bd-d7b9-4c51-9ff4-3ab47709f6d5\",https://collaborative-learning.concord.org/?unit=m2s&problem=4.5,2025-03-10T15:43:21,1,1,100.0,0,0,\"269: Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I like cheese.\n270: Question 1 Write a few sentences telling the donor the volume of water needed for the tank and explain how you got your solution.  I like pizza.\",\"269: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F85zp&studentDocumentHistoryId=anntEAki_54lesjhGRaF4\n270: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.portal.staging.concord.org%2Fapi%2Fv1%2Fofferings%2F588&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.portal.staging.concord.org%2F&resourceLinkId=588&targetUserId=266&studentDocument=-OK7YQig6OxOLf9F85zq&studentDocumentHistoryId=anntEAki_54lesjhGRaF5"\r
      """

      {job, query_result, overrides, get_output} = job_fixture(input, [MergeToPrimaryUser.step()])
      Job.run(job, query_result, nil, overrides)
      assert get_output.() == output
    end

    test "runs the merge to primary user step successfully for multiple resources" do
      input = """
      "student_id","user_id","primary_user_id","student_name","username","school","class","class_id","permission_forms","teacher_user_ids","teacher_names","teacher_districts","teacher_states","teacher_emails","res_1_name","res_1_offering_id","res_1_learner_id","res_1_remote_endpoint","res_1_resource_url","res_1_last_run","res_1_total_num_questions","res_1_total_num_answers","res_1_total_percent_complete","res_1_num_required_questions","res_1_num_required_answers","res_2_name","res_2_offering_id","res_2_learner_id","res_2_remote_endpoint","res_2_resource_url","res_2_last_run","res_2_total_num_questions","res_2_total_num_answers","res_2_total_percent_complete","res_2_num_required_questions","res_2_num_required_answers","res_3_name","res_3_offering_id","res_3_learner_id","res_3_remote_endpoint","res_3_resource_url","res_3_last_run","res_3_total_num_questions","res_3_total_num_answers","res_3_total_percent_complete","res_3_num_required_questions","res_3_num_required_answers","res_4_name","res_4_offering_id","res_4_learner_id","res_4_remote_endpoint","res_4_resource_url","res_4_last_run","res_4_total_num_questions","res_4_total_num_answers","res_4_total_percent_complete","res_4_num_required_questions","res_4_num_required_answers","res_1_text_5_text","res_1_text_5_url","res_1_text_4_text","res_1_text_4_url","res_1_text_3_text","res_1_text_3_url","res_1_text_2_text","res_1_text_2_url","res_1_text_1_text","res_1_text_1_url","res_1_templatetexttile_text","res_1_templatetexttile_url","res_2_text_9_text","res_2_text_9_url","res_2_text_8_text","res_2_text_8_url","res_2_text_7_text","res_2_text_7_url","res_2_text_6_text","res_2_text_6_url","res_2_text_5_text","res_2_text_5_url","res_2_text_4_text","res_2_text_4_url","res_2_text_3_text","res_2_text_3_url","res_2_text_2_text","res_2_text_2_url","res_2_text_11_text","res_2_text_11_url","res_2_text_10_text","res_2_text_10_url","res_2_text_1_text","res_2_text_1_url","res_2_templatetexttile_text","res_2_templatetexttile_url","res_3_text_5_text","res_3_text_5_url","res_3_text_4_text","res_3_text_4_url","res_3_text_3_text","res_3_text_3_url","res_3_text_2_text","res_3_text_2_url","res_3_text_1_text","res_3_text_1_url","res_3_templatetexttile_text","res_3_templatetexttile_url","res_4_text_43_text","res_4_text_43_url","res_4_text_42_text","res_4_text_42_url","res_4_text_41_text","res_4_text_41_url","res_4_text_40_text","res_4_text_40_url","res_4_text_39_text","res_4_text_39_url","res_4_text_38_text","res_4_text_38_url","res_4_text_1_text","res_4_text_1_url","res_4_templatetexttile_text","res_4_templatetexttile_url","res_4_q4_7question_3_text","res_4_q4_7question_3_url","res_4_q4_7question_2_text","res_4_q4_7question_2_url","res_4_q4_7question5_text","res_4_q4_7question5_url","res_4_q4_7question1_text","res_4_q4_7question1_url","res_4_q4_7_question9_text","res_4_q4_7_question9_url"
      "Correct answer",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
      "Prompt",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,"Text 5","Text 5","Text 4","Text 4","Text 3","Text 3","Text 2","Text 2","Text 1","Text 1","TemplateTextTile","TemplateTextTile","Text 9","Text 9","Text 8","Text 8","Text 7","Text 7","Text 6","Text 6","Text 5","Text 5","Text 4","Text 4","Text 3","Text 3","Text 2","Text 2","Text 11","Text 11","Text 10","Text 10","Text 1","Text 1","TemplateTextTile","TemplateTextTile","Text 5","Text 5","Text 4","Text 4","Text 3","Text 3","Text 2","Text 2","Text 1","Text 1","TemplateTextTile","TemplateTextTile","Text 43","Text 43","Text 42","Text 42","Text 41","Text 41","Text 40","Text 40","Text 39","Text 39","Text 38","Text 38","Text 1","Text 1","TemplateTextTile","TemplateTextTile","4_7Question 3","4_7Question 3","4_7Question 2","4_7Question 2","4_7Question5","4_7Question5","4_7Question1","4_7Question1","4_7_Question9","4_7_Question9"
      "1270798","1407981","1406114","George Jeston","jjetson32","Concord Consortium","Aug2024","254","[]","88","Boris Goldowsky","","","bgoldowsky@concord.org","Test Clue","588","2254547","https://learn.concord.org/dataservice/external_activity_data/c76d1e38-348d-4270-a2dc-3609484128a5","https://collaborative-learning.concord.org/?unit=m2s&problem=6.1","2025-01-09T20:02:37","6","0","0.0","0","0","Test Clue",,,,,,"12",,,,,"Test Clue",,,,,,"6",,,,,"Test Clue",,,,,,"13",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
      "1271503","1408724","1406114","George Jeston","jjetson35","Concord Consortium","Aug2024","254","[]","88","Boris Goldowsky","","","bgoldowsky@concord.org","Test Clue","588","2255972","https://learn.concord.org/dataservice/external_activity_data/197354b2-6cbb-40ae-b678-9cc35a8919a5","https://collaborative-learning.concord.org/?unit=m2s&problem=6.1","2025-01-10T19:57:30","6","0","0.0","0","0","Test Clue","173171","2260283","https://learn.concord.org/dataservice/external_activity_data/1c9347d1-e3bb-4638-bbf0-54f7a9f1f989","https://collaborative-learning.concord.org/?unit=m2s&problem=6.2","2025-01-17T19:55:54","12","3","25.0","0","0","Test Clue","173234","2265389","https://learn.concord.org/dataservice/external_activity_data/cc1ae4a4-2208-4aa4-8feb-045a4722f6f4","https://collaborative-learning.concord.org/?unit=m2s&problem=6.4","2025-01-22T19:24:40","6","2","33.3","0","0","Test Clue","181841","2271097","https://learn.concord.org/dataservice/external_activity_data/2144105c-2410-4dd9-adc6-65ff0dfef6a1","https://collaborative-learning.concord.org/?unit=m2s&problem=6.7","2025-01-29T19:46:10","13","2","15.4","0","0",,,,,,,,,,,,,,,,,,,,,,,,,"2C. How do those assumptions impact the friend's final number? one of them spend more than 11 hours at school. ","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173171&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173171&targetUserId=1408724&studentDocument=-OGfTPF1I6eCYg9ly6en&studentDocumentHistoryId=","2A. Bold the name of the friend you were assigned to examine   Friend Y  ","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173171&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173171&targetUserId=1408724&studentDocument=-OGfTPF1I6eCYg9ly6en&studentDocumentHistoryId=",,,,,"(Slide 14) Question 1 List  at least 3 assumptions  made to simplify the question about time spent at South City High School. football 24 hours in a day 8 hours in a school day 4 hours  every day","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173171&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173171&targetUserId=1408724&studentDocument=-OGfTPF1I6eCYg9ly6en&studentDocumentHistoryId=",,,,,,,,,"Instructions : To answer the questions below, drag each tile by its 6 dots into your workspace. Once in your workspace, the tiles will become editable.  Wait until your teacher tells you before you answer the question. ","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173234&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173234&targetUserId=1408724&studentDocument=-OH9Z0D7JZclG6Lx26Ev&studentDocumentHistoryId=","American Wages The U.S. Bureau of Labor Statistics keeps track of salaries around the country. The Bureau also has tools and apps on their website to help workers with different financial questions, such as comparing salaries across states or adjusting for inflation.  An intern at the Bureau wants to  create an app to help hourly workers  determine how much money they earn. The intern is using M2Studio to build this app. Over the next several slides, the intern will present their steps to you. It is your task to determine if the intern needs to make revisions or can use their work as is.  In the state of Iowa: Minimum wage workers are paid $7.25/hour For tip workers, the employer only needs to pay $4.35/hour. If a worker does not earn enough tips, the employer must cover the difference to reach $7.25/hour.","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173234&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173234&targetUserId=1408724&studentDocument=-OH9Z0D7JZclG6Lx26Ev&studentDocumentHistoryId=",,,,,,,,,,,,,"3. Write detailed modeling memos of your process .  Number of fish: 30 fish. Types  of fish: 6 placo 20 red force circled 4 bamboo sharks. Gallons of water: 892. Total of water: tank 2:2e 900 gallons.","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F181841&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=181841&targetUserId=1408724&studentDocument=-OHdKf6FFtbz_2gfxFOL&studentDocumentHistoryId=",,,,,,,,,,,,,"References List all the references you used below. The list has been started for you. 1. 6 placo because they clean the tank 2. Average Rental Price in Cambridge, MA & Market Trends | Zillow Rental Manager 3.  4. 5.","https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F181841&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=181841&targetUserId=1408724&studentDocument=-OHdKf6FFtbz_2gfxFOL&studentDocumentHistoryId="
      """

      output = """
      student_id,user_id,primary_user_id,merged_user_ids,student_name,username,school,class,class_id,permission_forms,teacher_user_ids,teacher_names,teacher_districts,teacher_states,teacher_emails,res_1_name,res_1_offering_id,res_1_learner_id,res_1_remote_endpoint,res_1_resource_url,res_1_last_run,res_1_total_num_questions,res_1_total_num_answers,res_1_total_percent_complete,res_1_num_required_questions,res_1_num_required_answers,res_2_name,res_2_offering_id,res_2_learner_id,res_2_remote_endpoint,res_2_resource_url,res_2_last_run,res_2_total_num_questions,res_2_total_num_answers,res_2_total_percent_complete,res_2_num_required_questions,res_2_num_required_answers,res_3_name,res_3_offering_id,res_3_learner_id,res_3_remote_endpoint,res_3_resource_url,res_3_last_run,res_3_total_num_questions,res_3_total_num_answers,res_3_total_percent_complete,res_3_num_required_questions,res_3_num_required_answers,res_4_name,res_4_offering_id,res_4_learner_id,res_4_remote_endpoint,res_4_resource_url,res_4_last_run,res_4_total_num_questions,res_4_total_num_answers,res_4_total_percent_complete,res_4_num_required_questions,res_4_num_required_answers,res_1_text_5_text,res_1_text_5_url,res_1_text_4_text,res_1_text_4_url,res_1_text_3_text,res_1_text_3_url,res_1_text_2_text,res_1_text_2_url,res_1_text_1_text,res_1_text_1_url,res_1_templatetexttile_text,res_1_templatetexttile_url,res_2_text_9_text,res_2_text_9_url,res_2_text_8_text,res_2_text_8_url,res_2_text_7_text,res_2_text_7_url,res_2_text_6_text,res_2_text_6_url,res_2_text_5_text,res_2_text_5_url,res_2_text_4_text,res_2_text_4_url,res_2_text_3_text,res_2_text_3_url,res_2_text_2_text,res_2_text_2_url,res_2_text_11_text,res_2_text_11_url,res_2_text_10_text,res_2_text_10_url,res_2_text_1_text,res_2_text_1_url,res_2_templatetexttile_text,res_2_templatetexttile_url,res_3_text_5_text,res_3_text_5_url,res_3_text_4_text,res_3_text_4_url,res_3_text_3_text,res_3_text_3_url,res_3_text_2_text,res_3_text_2_url,res_3_text_1_text,res_3_text_1_url,res_3_templatetexttile_text,res_3_templatetexttile_url,res_4_text_43_text,res_4_text_43_url,res_4_text_42_text,res_4_text_42_url,res_4_text_41_text,res_4_text_41_url,res_4_text_40_text,res_4_text_40_url,res_4_text_39_text,res_4_text_39_url,res_4_text_38_text,res_4_text_38_url,res_4_text_1_text,res_4_text_1_url,res_4_templatetexttile_text,res_4_templatetexttile_url,res_4_q4_7question_3_text,res_4_q4_7question_3_url,res_4_q4_7question_2_text,res_4_q4_7question_2_url,res_4_q4_7question5_text,res_4_q4_7question5_url,res_4_q4_7question1_text,res_4_q4_7question1_url,res_4_q4_7_question9_text,res_4_q4_7_question9_url\r
      Correct answer,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,\r
      Prompt,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,Text 5,Text 5,Text 4,Text 4,Text 3,Text 3,Text 2,Text 2,Text 1,Text 1,TemplateTextTile,TemplateTextTile,Text 9,Text 9,Text 8,Text 8,Text 7,Text 7,Text 6,Text 6,Text 5,Text 5,Text 4,Text 4,Text 3,Text 3,Text 2,Text 2,Text 11,Text 11,Text 10,Text 10,Text 1,Text 1,TemplateTextTile,TemplateTextTile,Text 5,Text 5,Text 4,Text 4,Text 3,Text 3,Text 2,Text 2,Text 1,Text 1,TemplateTextTile,TemplateTextTile,Text 43,Text 43,Text 42,Text 42,Text 41,Text 41,Text 40,Text 40,Text 39,Text 39,Text 38,Text 38,Text 1,Text 1,TemplateTextTile,TemplateTextTile,4_7Question 3,4_7Question 3,4_7Question 2,4_7Question 2,4_7Question5,4_7Question5,4_7Question1,4_7Question1,4_7_Question9,4_7_Question9\r
      1270798,1407981,1406114,\"1407981,1408724\",George Jeston,jjetson32,Concord Consortium,Aug2024,254,[],88,Boris Goldowsky,,,bgoldowsky@concord.org,Test Clue,588,\"1407981: 2254547\n1408724: 2255972\",\"1407981: https://learn.concord.org/dataservice/external_activity_data/c76d1e38-348d-4270-a2dc-3609484128a5\n1408724: https://learn.concord.org/dataservice/external_activity_data/197354b2-6cbb-40ae-b678-9cc35a8919a5\",https://collaborative-learning.concord.org/?unit=m2s&problem=6.1,\"1407981: 2025-01-09T20:02:37\n1408724: 2025-01-10T19:57:30\",6,0,0.0,0,0,Test Clue,1408724: 173171,1408724: 2260283,1408724: https://learn.concord.org/dataservice/external_activity_data/1c9347d1-e3bb-4638-bbf0-54f7a9f1f989,1408724: https://collaborative-learning.concord.org/?unit=m2s&problem=6.2,1408724: 2025-01-17T19:55:54,12,1408724: 3,1408724: 25.0,1408724: 0,1408724: 0,Test Clue,1408724: 173234,1408724: 2265389,1408724: https://learn.concord.org/dataservice/external_activity_data/cc1ae4a4-2208-4aa4-8feb-045a4722f6f4,1408724: https://collaborative-learning.concord.org/?unit=m2s&problem=6.4,1408724: 2025-01-22T19:24:40,6,1408724: 2,1408724: 33.3,1408724: 0,1408724: 0,Test Clue,1408724: 181841,1408724: 2271097,1408724: https://learn.concord.org/dataservice/external_activity_data/2144105c-2410-4dd9-adc6-65ff0dfef6a1,1408724: https://collaborative-learning.concord.org/?unit=m2s&problem=6.7,1408724: 2025-01-29T19:46:10,13,1408724: 2,1408724: 15.4,1408724: 0,1408724: 0,,,,,,,,,,,,,,,,,,,,,,,,,1408724: 2C. How do those assumptions impact the friend's final number? one of them spend more than 11 hours at school. ,1408724: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173171&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173171&targetUserId=1408724&studentDocument=-OGfTPF1I6eCYg9ly6en&studentDocumentHistoryId=,1408724: 2A. Bold the name of the friend you were assigned to examine   Friend Y  ,1408724: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173171&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173171&targetUserId=1408724&studentDocument=-OGfTPF1I6eCYg9ly6en&studentDocumentHistoryId=,,,,,1408724: (Slide 14) Question 1 List  at least 3 assumptions  made to simplify the question about time spent at South City High School. football 24 hours in a day 8 hours in a school day 4 hours  every day,1408724: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173171&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173171&targetUserId=1408724&studentDocument=-OGfTPF1I6eCYg9ly6en&studentDocumentHistoryId=,,,,,,,,,\"1408724: Instructions : To answer the questions below, drag each tile by its 6 dots into your workspace. Once in your workspace, the tiles will become editable.  Wait until your teacher tells you before you answer the question. \",1408724: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173234&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173234&targetUserId=1408724&studentDocument=-OH9Z0D7JZclG6Lx26Ev&studentDocumentHistoryId=,\"1408724: American Wages The U.S. Bureau of Labor Statistics keeps track of salaries around the country. The Bureau also has tools and apps on their website to help workers with different financial questions, such as comparing salaries across states or adjusting for inflation.  An intern at the Bureau wants to  create an app to help hourly workers  determine how much money they earn. The intern is using M2Studio to build this app. Over the next several slides, the intern will present their steps to you. It is your task to determine if the intern needs to make revisions or can use their work as is.  In the state of Iowa: Minimum wage workers are paid $7.25/hour For tip workers, the employer only needs to pay $4.35/hour. If a worker does not earn enough tips, the employer must cover the difference to reach $7.25/hour.\",1408724: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F173234&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=173234&targetUserId=1408724&studentDocument=-OH9Z0D7JZclG6Lx26Ev&studentDocumentHistoryId=,,,,,,,,,,,,,1408724: 3. Write detailed modeling memos of your process .  Number of fish: 30 fish. Types  of fish: 6 placo 20 red force circled 4 bamboo sharks. Gallons of water: 892. Total of water: tank 2:2e 900 gallons.,1408724: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F181841&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=181841&targetUserId=1408724&studentDocument=-OHdKf6FFtbz_2gfxFOL&studentDocumentHistoryId=,,,,,,,,,,,,,\"1408724: References List all the references you used below. The list has been started for you. 1. 6 placo because they clean the tank 2. Average Rental Price in Cambridge, MA & Market Trends | Zillow Rental Manager 3.  4. 5.\",1408724: https://collaborative-learning.concord.org/?class=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fclasses%2F254&offering=https%3A%2F%2Flearn.concord.org%2Fapi%2Fv1%2Fofferings%2F181841&researcher=true&reportType=offering&authDomain=https%3A%2F%2Flearn.concord.org%2F&resourceLinkId=181841&targetUserId=1408724&studentDocument=-OHdKf6FFtbz_2gfxFOL&studentDocumentHistoryId=\r
      """

      {job, query_result, overrides, get_output} = job_fixture(input, [MergeToPrimaryUser.step()])
      Job.run(job, query_result, nil, overrides)
      assert get_output.() == output
    end
  end
end
